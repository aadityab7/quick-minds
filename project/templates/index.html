{% extends 'base.html' %}

{% block title %}QUICK MINDS{% endblock %}

{% block content %}
	<div class="mx-auto max-w-screen-xl px-4 py-8 sm:px-6 lg:px-8">

		<div id="lower" class="grow py-3 px-3 rounded-t-lg">
			<a href="{{url_for('ask_question')}}"> ASK QUESTION </a>

		    <div id="for_you_page">
		        <template id="question-template">
		          	<a href="">
		            	<div class="question-list-box">
		              		<p id = "user_id"></p>
		              		<p id = "user_name"></p>
		              		<p id = "question_text"> </p>
		              		<p id = "created_time"></p>
		              		<p id = "vote_counter"></p>
		              		<p id = "response_counter"></p>
		            	</div>
		          	</a>
		        </template>
		    </div>
	    </div>
	</div>

    <script>
	  
	    var for_you_page = document.getElementById('for_you_page');

	    // Lazy loading and infinite scrolling
	    var offset = {{ questions|length }}; 
	    // Adjust the initial offset based on what's already loaded for "For You"
	 
	    var numToLoad = 10;  // Adjust the number of questions to load at a time
	    var isLoading = false;  // Flag to track whether an AJAX request is in progress
	    var loadComplete = false; // All "For You" questions already loaded
	    
	    // Function to check if the user has scrolled to the bottom of the page
	    function isScrolledToBottom() {
	        var scrollTop = $(window).scrollTop();
	        var windowHeight = $(window).height();
	        var documentHeight = $(document).height();

	        // Check if the user is close to the bottom (e.g., within 100 pixels)
	        return (documentHeight - (scrollTop + windowHeight) < 100);
	    }

	    // Function to load more questions
	    function loadMoreQuestions() {
	        if (loadComplete) {
	            return;
	        } 

	        // Check if an AJAX request is already in progress
	        if (isLoading) {
	            return;
	        }

	        // Set the isLoading flag to true
	        isLoading = true;
	        
	        // Determine the current section and its respective offset
	        var currentOffset = offset;

	        // Send an AJAX request to fetch more questions
	        $.ajax({
	            type: 'POST',
	            url: '/load_more_questions',
	            data: { num_to_load: numToLoad, offset: currentOffset},
	            success: function (data) {
                    if (data.questions.length === 0) {
                        loadComplete = true;
                    }

                    data.questions.forEach(function (question) {
                        // Clone the template and populate it with data
                        var template = document.getElementById("question-template");
                        var clone = document.importNode(template.content, true);

                        // Create the URL with the question_id
                        var question_url = "/question_detail/" + question.question_id + "/";

                        clone.querySelector("a").setAttribute("href", question_url);
                        clone.querySelector("#user_id").textContent = question.user_id;
                        clone.querySelector("#user_name").textContent = question.user_name;
                        clone.querySelector("#response_counter").textContent = question.response_counter;
                        clone.querySelector("#question_text").textContent = question.question_text;
                        clone.querySelector("#created_time").textContent = question.created_time;
                        clone.querySelector("#vote_counter").textContent = question.vote_counter;

                        if (question.vote_counter > 0) {
                            clone.querySelector("#vote_counter").classList.add('text-green-600');
                        } else if (question.vote_counter < 0) {
                            clone.querySelector("#vote_counter").classList.add('text-red-600');
                        }

                        // Append the populated template to the appropriate container
                        document.getElementById('for_you_page').appendChild(clone);
                    });

                    // Update the offset for "For You"
                    offset += numToLoad;
                    isLoading = false;
	               
	            }
	        });
	    }

	    // Load initial data for both sections when the page loads
	    loadMoreQuestions();

	    // Load more questions when scrolling to the bottom
	    $(window).scroll(function () {
	        if (isScrolledToBottom()) {
	            console.log('Scrolled to the bottom');
	            loadMoreQuestions();	        }
	    });
	</script>

{% endblock %}