{% extends 'base.html' %}

{% block title %}QUESTION DETAIL{% endblock %}

{% block content %}
	

	<div class="mx-auto max-w-screen-xl px-4 py-8 sm:px-6 lg:px-8">
		
			
		<div class="flex items-center justify-between mb-3 gap-4">	
			<h1 class="text-xl font-bold">{{question["question_title"]}}</h1>

			<a href="{{url_for('ask_question')}}"> 
				<button type="submit" class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">Ask Question</button>
			</a>
		</div>

		<div class="block sm:flex items-start gap-4 mb-2 items-center">
      		<p id = "user_name" class="text-gray-500 font-bold">{{question["user_name"]}}</p>
      		<p id = "created_time" class="text-gray-500">{{question["created_time"]}}</p>
      	</div>
		
		<div class="mt-8 grid grid-cols-12 items-start gap-2 sm:gap-0">
			<div id = "question_votes" class="col-span-1 align-center justify-center">
				<div class="flex mb-2 align-center justify-center">
					<button>
						<img class = 'w-6' src="https://img.icons8.com/ios/50/circled-chevron-up.png">
					</button>
				</div>
				
				<div class="flex align-center justify-center">
					<p id = "vote_counter" class="text-l font-bold">{{question["vote_counter"]}}</p>
				</div>
  				
				<div class="flex mt-2 align-center justify-center">
					<button>
						<img class="w-6" src="https://img.icons8.com/ios/50/circled-chevron-down.png">
					</button>	
				</div>
				
			</div>

			<div id = 'question_details' class="col-span-11">
				{{ question['question_text'] |safe }}
			</div>
		</div>
		

		<hr class="my-4">

		<div id = "responses">
			<h1 id = "question_response_counter" class="text-xl font-bold text-gray-500">{{question["response_counter"]}} Response</h1>

			<template id="response-template">

				<div id = "complete_repsonse_block" class="grid grid-cols-12 items-start gap-2 sm:gap-0" data-response-id = "">
					<div id = 'response-votes' class="py-4 col-span-1 align-center justify-center">
						<div class="flex mb-2 align-center justify-center">
							<button>
								<img id="response_upvote_button" data-response-id = "" class = 'w-6' src="https://img.icons8.com/ios/50/circled-chevron-up.png">
							</button>
						</div>
						
						<div class="flex align-center justify-center">
							<p id = "response_vote_counter" class="text-l font-bold"></p>
						</div>
		  				
						<div class="flex mt-2 align-center justify-center">
							<button>
								<img id="response_downvote_button" data-response-id = "" class="w-6" src="https://img.icons8.com/ios/50/circled-chevron-down.png">
							</button>	
						</div>
					</div>

					<div id = 'single-response' class="col-span-11 p-4">
		            	<div class="response-list-box">
		            		<div class="sm:flex items-start gap-4 mb-2 items-center">
			              		<p id = "user_name" class="text-gray-500 font-bold"></p>
			              		<p id = "created_time" class="text-gray-500"></p>
			              	</div>

		              		<h1 id = "response_text" class="sm:text-xl"> </h1>
		              		
		              		<div class="flex items-start gap-4 mt-2">
		              			
		              			<p id = "response_counter" class="text-gray-500 text-sm font-bold"></p>
		              		</div>
		            	</div>
					</div>
				</div>
				
	          	<hr>
	        </template>

		</div>

        <button id = "load-more-button" class="hidden mt-4 rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">Load more responses</button>

        <p id = "no-more-responses" class="hidden mt-4">No more responses available</p>

        <hr class="my-4">

        <form id = "add_response_form" method="post" enctype = "multipart/form-data">
			<div>
				<div class="pb-4">
					<div class="grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6">
						<div class="col-span-full">
					          <h1 class="text-xl font-bold text-gray-500">Share your Response</h1>

					          <div class="mt-2">
					            <textarea id="response-text" name="response-text" rows="2" class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"></textarea>
					          </div>
					          <div class="flex items-center gap-2 mt-2">
					          	<svg class="h-5 w-5 text-gray-300" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
						            <path fill-rule="evenodd" d="M1.5 6a2.25 2.25 0 012.25-2.25h16.5A2.25 2.25 0 0122.5 6v12a2.25 2.25 0 01-2.25 2.25H3.75A2.25 2.25 0 011.5 18V6zM3 16.06V18c0 .414.336.75.75.75h16.5A.75.75 0 0021 18v-1.94l-2.69-2.689a1.5 1.5 0 00-2.12 0l-.88.879.97.97a.75.75 0 11-1.06 1.06l-5.16-5.159a1.5 1.5 0 00-2.12 0L3 16.061zm10.125-7.81a1.125 1.125 0 112.25 0 1.125 1.125 0 01-2.25 0z" clip-rule="evenodd" />
						        </svg>
						        <label for="file-upload" class="relative cursor-pointer rounded-md bg-white font-semibold text-indigo-600 focus-within:outline-none focus-within:ring-2 focus-within:ring-indigo-600 focus-within:ring-offset-2 hover:text-indigo-500">
						            <span>Add Image</span>
						            <input id="file-upload" name="file-upload" type="file" class="sr-only" accept=".png, .jpg, .jpeg, .gif">
					            </label>
					          </div>
					          <p class="mt-3 text-sm leading-6 text-gray-600">Images are useful in a post, but make sure the post is still clear without them. If you post images of code or error messages, copy and paste or type the actual code or message into the post directly. <b>PNG, JPG, GIF up to 10MB</b></p>
					          
				        </div>
					</div>
				</div>
			</div>

			<button id = "response-button" type="button" class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">Post your response</button>
		</form>

		<hr class="my-4">

	</div>

	<script>
	    var offset = {{ responses|length }};
	    var numToLoad = 10;
	    var isLoading = false;
	    var loadComplete = false;

	    const question_id = {{question.question_id}};
	    const add_response_form = document.getElementById('add_response_form');
	    const responses = document.getElementById('responses');
	    const fileInput = document.getElementById('file-upload');

	    // Function to load more questions
	    function loadMoreQuestions() {
	        if (loadComplete) {
	            return;
	        }

	        if (isLoading) {
	            return;
	        }

	        document.getElementById('load-more-button').classList.add('hidden');

	        isLoading = true;

	        var currentOffset = offset;

	        $.ajax({
	            type: 'POST',
	            url: '/load_more_responses',
	            data: { question_id: question_id, num_to_load: numToLoad, offset: currentOffset },
	            success: function (data) {
	                if (data.responses.length === 0) {
	                    loadComplete = true;
	                }

	                data.responses.forEach(function (response) {
	                    var template = document.getElementById("response-template");
	                    var clone = document.importNode(template.content, true);
	                    
	                    clone.querySelector("#complete_repsonse_block").setAttribute("data-response-id", response.response_id);
	                    clone.querySelector("#response_upvote_button").setAttribute("data-response-id", response.response_id);
	                    clone.querySelector("#response_downvote_button").setAttribute("data-response-id", response.response_id);

	                    clone.querySelector("#user_name").textContent = response.user_name;
	                    clone.querySelector("#response_counter").textContent = response.response_counter + ' comments';
	                    clone.querySelector("#response_text").textContent = response.response_text;
	                    clone.querySelector("#created_time").textContent = response.created_time;
	                    clone.querySelector("#response_vote_counter").textContent = response.vote_counter;

	                    if (response.vote_counter > 0) {
	                        clone.querySelector("#response_vote_counter").classList.add('text-green-600');
	                    } else if (response.vote_counter < 0) {
	                        clone.querySelector("#response_vote_counter").classList.add('text-red-600');
	                    }

	                    document.getElementById('responses').appendChild(clone);
	                });

	                offset += numToLoad;
	                isLoading = false;

			        if (loadComplete === false){
			    	    document.getElementById('load-more-button').classList.remove('hidden');
			        }
			        else{
			        	document.getElementById('no-more-responses').classList.remove('hidden');
			        }

	            }
	        });
	    }

	    // Load initial data for both sections when the page loads
	    loadMoreQuestions();

	    fileInput.addEventListener('change', function () {
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                	
                	const formData = new FormData();
                	formData.append("image", fileInput.files[0]);
                	
                	// Make an AJAX request to the Flask server
	                fetch('/upload_image', {
	                    method: 'POST',
	                    body: formData
	                })
	                .then(response => response.json())
	                .then(data => {
	                    const imageUrl = data.url;
	                    const imageMarkdown = `![Alt Text](${imageUrl})`;
	                    const markdownInput = document.getElementById("response-text");
	                    markdownInput.value += imageMarkdown;
	                })
	                .catch(error => {
	                    console.error('Error uploading image:', error);
	                });

                };
                reader.readAsDataURL(file);
            }
        });

        function add_response_to_list(response) {
			var template = document.getElementById("response-template");
            var clone = document.importNode(template.content, true);
            
            clone.querySelector("#complete_repsonse_block").setAttribute("data-response-id", response.response_id);
            clone.querySelector("#response_upvote_button").setAttribute("data-response-id", response.response_id);
            clone.querySelector("#response_downvote_button").setAttribute("data-response-id", response.response_id);

            clone.querySelector("#user_name").textContent = response.user_name;
            clone.querySelector("#response_counter").textContent = response.response_counter + ' comments';
            clone.querySelector("#response_text").textContent = response.response_text;
            clone.querySelector("#created_time").textContent = response.created_time;
            clone.querySelector("#response_vote_counter").textContent = response.vote_counter;

            if (response.vote_counter > 0) {
                clone.querySelector("#response_vote_counter").classList.add('text-green-600');
            } else if (response.vote_counter < 0) {
                clone.querySelector("#response_vote_counter").classList.add('text-red-600');
            }

            document.getElementById('responses').appendChild(clone);
        }

        function handleResponseVoteClick(event, post_type, up_or_down_vote) {
		    // Extract the response_id from the clicked button's data-response-id attribute
		    var responseId = event.target.getAttribute("data-response-id");

		    var responseContainer = document.querySelector(`[data-response-id="${responseId}"]`);
		    var voteCounter = responseContainer.querySelector("#response_vote_counter");

		    // Make a POST request to up-vote the response with the responseId
		    $.ajax({
		        type: 'POST',
		        url: '/vote_unvote',
		        data: { response_id: responseId, post_type: post_type, up_or_down_vote : up_or_down_vote},
		        success: function (data) {

		        	voteCounter.innerText = data.vote_count;

		        	if (data.vote_count > 0) {
		        		voteCounter.classList.remove('text-red-600');
		        		voteCounter.classList.add('text-green-600');
		        	}
		        	else if (data.vote_count < 0){
		        		voteCounter.classList.add('text-red-600');
		        		voteCounter.classList.remove('text-green-600');
		        	}
		        	else {
		        		voteCounter.classList.remove('text-red-600');
		        		voteCounter.classList.remove('text-green-600');
		        	}
		        }
		    });
		    
		}



		// Add an event listener to handle the up-vote button click
		document.addEventListener('click', function(event) {
		    if (event.target.id === 'response_upvote_button') {
		        handleResponseVoteClick(event, 'response', 'up');
		    }

		    if (event.target.id === 'response_downvote_button') {
		        handleResponseVoteClick(event, 'response', 'down');
		    }

		    if (event.target.id === 'response-button') {
		    	const response_text_element = document.getElementById('response-text');
	        	const response_text = response_text_element.value;

	        	$.ajax({
		            type: 'POST',
		            url: '/add_response',
		            data: {question_id : question_id, response_text: response_text},
		            success: function (data) {
		            	add_response_to_list(data.response);
		            	response_text_element.value = '';
		            	document.getElementById('question_response_counter').innerText = data.question_response_counter + ' response';
		            },
		            error: function(xhr, status, error) {
		                console.error('Error adding response:', error);
		            }
	        	});
		    }

		    // Load more responses when the "Load More" button is clicked
		    if (event.target.id === 'load-more-button') {
		    	loadMoreQuestions();
		    }
		});

	</script>


{% endblock %}